# -*- coding: utf-8 -*-
# @Time    : 2025/4/6 21:45
# @Author  : sjh
# @Site    : 
# @File    : Stereo.py
# @Comment :
import cv2
import numpy as np
import json
import glob
import os

class stereoRectify:
    def __init__(self, findChessboardCorners=False):
        
        self.findChessboardCorners = findChessboardCorners
        
        self.image_size = (1056, 784)   # å›¾åƒå°ºå¯¸
        # è®¾ç½®æ£‹ç›˜æ ¼çš„å°ºå¯¸ï¼Œå•ä½ï¼šç±³
        self.board_size = (9, 6)  # 11x8çš„æ£‹ç›˜æ ¼
        self.square_size = 0.0914  # æ¯ä¸ªæ–¹æ ¼çš„å°ºå¯¸

        # ä¸–ç•Œåæ ‡ç³»ä¸‹çš„è§’ç‚¹åæ ‡
        self.world_points = np.array([[x * self.square_size, y * self.square_size, 0] for y in range(self.board_size[1]) for x in range(self.board_size[0])], dtype=np.float32)
    # è¾“å…¥: å·¦å³ç›¸æœºæ‹æ‘„çš„æ£‹ç›˜æ ¼å›¾åƒï¼ˆæˆ–åœ†ç‚¹æ ‡å®šæ¿ï¼‰
    # è¾“å‡º: ç›¸æœºå†…å‚ï¼ˆK_left, K_rightï¼‰ã€ç•¸å˜ç³»æ•°ï¼ˆdist_left, dist_rightï¼‰ã€å¤–å‚ï¼ˆR, Tï¼‰

    def stereo_calibrate(self, left_images, right_images):
        # 1. åˆå§‹åŒ–æ ‡å®šæ¿è§’ç‚¹åæ ‡ï¼ˆä¸–ç•Œåæ ‡ç³»ï¼‰
        obj_points = []  # 3Dç‚¹ï¼ˆæ£‹ç›˜æ ¼è§’ç‚¹çš„ç‰©ç†åæ ‡ï¼‰
        left_img_points = []  # å·¦å›¾åƒ2Dç‚¹
        right_img_points = []  # å³å›¾åƒ2Dç‚¹
        detect_count = 0
        # 2. æ£€æµ‹æ£‹ç›˜æ ¼è§’ç‚¹
        for left_img, right_img in zip(left_images, right_images):
            img_left = cv2.imread(left_img)
            img_right = cv2.imread(right_img)
            gray_left = cv2.cvtColor(img_left, cv2.COLOR_BGR2GRAY)
            gray_right = cv2.cvtColor(img_right, cv2.COLOR_BGR2GRAY)
            if self.findChessboardCorners:
                # æ£€æµ‹å·¦å›¾åƒè§’ç‚¹
                ret_left, corners_left = cv2.findChessboardCorners(gray_left, self.board_size)
                # æ£€æµ‹å³å›¾åƒè§’ç‚¹
                ret_right, corners_right = cv2.findChessboardCorners(gray_right, self.board_size)
            else:
                flags = (cv2.CALIB_CB_SYMMETRIC_GRID) 
                    #  cv2.CALIB_CB_CLUSTERING )  # å¯ç”¨èšç±»ä¼˜åŒ–
                    #  cv2.CALIB_CB_ASYMMETRIC_GRID)  # é€‚åº”éå¯¹ç§°æ’åˆ—
                ret_left, corners_left = cv2.findCirclesGrid(gray_left, self.board_size, None, flags) 
                ret_right, corners_right = cv2.findCirclesGrid(gray_right, self.board_size, None, flags) 
                detect_count += 1
            if ret_left and ret_right:
                print("detect_count: ", detect_count)
                
                obj_points.append(self.world_points)  # 3Dç‚¹
                left_img_points.append(corners_left)  # å·¦å›¾åƒ2Dç‚¹
                right_img_points.append(corners_right)  # å³å›¾åƒ2Dç‚¹
                
                # å¯è§†åŒ–è§’ç‚¹
                cv2.drawChessboardCorners(img_left, self.board_size, corners_left, ret_left)
                cv2.drawChessboardCorners(img_right, self.board_size, corners_right, ret_right)
                combined_img = cv2.resize(np.hstack((img_left, img_right)), (1280, 720))
                cv2.imshow('Left Image', combined_img)
                cv2.waitKey(1)
            else:
                print('false')
        # 3. å•ç›®æ ‡å®šï¼ˆè®¡ç®—å†…å‚å’Œç•¸å˜ç³»æ•°ï¼‰
        ret_left, K_left, dist_left, rvecs_left, tvecs_left = cv2.calibrateCamera(
            obj_points, left_img_points, gray_left.shape[::-1], None, None
        )
        ret_right, K_right, dist_right, rvecs_right, tvecs_right = cv2.calibrateCamera(
            obj_points, right_img_points, gray_right.shape[::-1], None, None
        )
        # OmtxL, roiL = cv2.getOptimalNewCameraMatrix(K_left, dist_left, (gray_left.shape[1], gray_left.shape[0]), 1, (gray_left.shape[1], gray_left.shape[0]))
        # OmtxR, roiR = cv2.getOptimalNewCameraMatrix(K_right, dist_right, (gray_right.shape[1], gray_right.shape[0]), 1, (gray_right.shape[1], gray_right.shape[0]))
        # 4. åŒç›®æ ‡å®šï¼ˆè®¡ç®—æ—‹è½¬çŸ©é˜µ R å’Œå¹³ç§»å‘é‡ Tï¼‰
        ret, K_left_est, dist_left_est, K_right_est, dist_right_est, R, T, E, F = cv2.stereoCalibrate(
            obj_points,  # ä¸–ç•Œåæ ‡ç‚¹
            left_img_points,  # å·¦å›¾åƒçš„è§’ç‚¹
            right_img_points,  # å³å›¾åƒçš„è§’ç‚¹
            K_left, dist_left,  # å·¦ç›¸æœºå†…å‚å’Œç•¸å˜ç³»æ•°
            K_right, dist_right,  # å³ç›¸æœºå†…å‚å’Œç•¸å˜ç³»æ•°
            gray_left.shape[::-1],  # å›¾åƒå°ºå¯¸
            # criteria=(cv2.TERM_CRITERIA_EPS + cv2.TERM_CRITERIA_MAX_ITER, 30, 0.001)  # ç²¾åº¦å’Œæœ€å¤§è¿­ä»£æ¬¡æ•°
        )
        print(K_left, K_left_est)
        print(K_right, K_right_est)
        print(dist_left, dist_left_est)
        print(dist_right, dist_right_est)
        left_reprojection_error = self.compute_reprojection_error(obj_points, left_img_points, rvecs_left, tvecs_left, K_left_est, dist_left_est)
        right_reprojection_error = self.compute_reprojection_error(obj_points, right_img_points, rvecs_right, tvecs_right, K_right_est, dist_right_est)
        print("Left Reprojection Error: \n", left_reprojection_error)
        print("Right Reprojection Error: \n", right_reprojection_error)
        
        # 5. è®¡ç®—æ ¡æ­£å˜æ¢çŸ©é˜µ
        _, _, _, _, Q = self.stereo_rectify_without_distortion(K_left_est, K_right_est, R, T, gray_left.shape[::-1])
        # _, _, _, _, Q = self.stereo_rectify_with_distortion(K_left_est, dist_left_est, K_right_est, dist_right_est, R, T, gray_left.shape[::-1])
        
        # æ‰“å°è®¡ç®—ç»“æœ
        print("Left Camera Intrinsics: \n", K_left_est)
        print("Left Camera Distortion Coefficients: \n", dist_left_est)
        print("Right Camera Intrinsics: \n", K_right_est)
        print("Right Camera Distortion Coefficients: \n", dist_right_est)
        print("Rotation Matrix: \n", R)
        print("Translation Vector: \n", T)
        print("Essential Matrix: \n", E)
        print("Fundamental Matrix: \n", F)
        print("Q Matrix: \n", Q)
        self.calculate_fx_fy_cx_cy_baseline(np.array(Q))
        print("fx: \n", self.fx)
        print("fy: \n", self.fy)
        print("cx: \n", self.cx)
        print("cy: \n", self.cy)
        print("baseline: \n", self.baseline)
        return K_left, dist_left, K_right, dist_right, R, T, Q
    # è®¡ç®—é‡æŠ•å½±è¯¯å·®
    def compute_reprojection_error(self, object_points, image_points, rvecs, tvecs, camera_matrix, dist_coeffs):
        """
        å¯¹æ‰€æœ‰å›¾åƒè®¡ç®—é‡æŠ•å½±å‡æ–¹æ ¹è¯¯å·®(RMSE)
        """
        total_error = 0
        total_points = 0
        for i in range(len(object_points)):
            # å°†3Dç‚¹æŠ•å½±åˆ°å›¾åƒå¹³é¢
            imgpoints2, _ = cv2.projectPoints(object_points[i], rvecs[i], tvecs[i], camera_matrix, dist_coeffs)
            # è®¡ç®—æŠ•å½±ç‚¹ä¸å®é™…æ£€æµ‹åˆ°çš„è§’ç‚¹ä¹‹é—´çš„æ¬§æ°è·ç¦»
            error = cv2.norm(image_points[i], imgpoints2, cv2.NORM_L2)
            total_error += error**2
            total_points += len(object_points[i])
        mean_error = np.sqrt(total_error / total_points)
        return mean_error
    # è®¡ç®—æœ‰ç•¸å˜ç«‹ä½“æ ¡æ­£å˜æ¢
    def stereo_rectify_with_distortion(self, K_left, dist_left, K_right, dist_right, R, T, image_size):
        # 1. è®¡ç®—æ ¡æ­£å˜æ¢çŸ©é˜µ
        R1, R2, P1, P2, Q, roi1, roi2 = cv2.stereoRectify(
            K_left, dist_left, K_right, dist_right, image_size, R, T#, alpha=0
        )
        # 2. è®¡ç®—æ˜ å°„è¡¨ï¼ˆè€ƒè™‘ç•¸å˜ï¼‰
        map1x, map1y = cv2.initUndistortRectifyMap(K_left, dist_left, R1, P1, image_size, cv2.CV_32FC1)
        map2x, map2y = cv2.initUndistortRectifyMap(K_right, dist_right, R2, P2, image_size, cv2.CV_32FC1)
        
        return map1x, map1y, map2x, map2y, Q
    
    # è®¡ç®—æ— ç•¸å˜ç«‹ä½“æ ¡æ­£å˜æ¢
    def stereo_rectify_without_distortion(self, K_left, K_right, R, T, image_size):
        # 1. è®¡ç®—æ ¡æ­£å˜æ¢çŸ©é˜µ
        R1, R2, P1, P2, Q, roi1, roi2 = cv2.stereoRectify(
            K_left, None, K_right, None, image_size, R, T
        )
        # 2. è®¡ç®—æ˜ å°„è¡¨ï¼ˆæ— ç•¸å˜ï¼Œä»…æ ¡æ­£ï¼‰
        map1x, map1y = cv2.initUndistortRectifyMap(K_left, None, R1, P1, image_size, cv2.CV_32FC1)
        map2x, map2y = cv2.initUndistortRectifyMap(K_right, None, R2, P2, image_size, cv2.CV_32FC1)
        
        return map1x, map1y, map2x, map2y, Q

    # è®¡ç®—fx,fy,cx,cy,baseline
    def calculate_fx_fy_cx_cy_baseline(self, Q):
        self.cx = -Q[0, 3]
        self.cy = -Q[1, 3]
        self.fx = Q[2, 3]
        self.fy = Q[2, 3]
        self.baseline = abs(1.0 / Q[3, 2])
        # return self.fx, self.fy, self.cx, self.cy, self.baseline
    # åº”ç”¨æ ¡æ­£å˜æ¢
    def apply_rectification(self, left_img, right_img, map1x, map1y, map2x, map2y):
        # 1. é‡æ˜ å°„
        rectified_left = cv2.remap(left_img, map1x, map1y, cv2.INTER_LINEAR)
        rectified_right = cv2.remap(right_img, map2x, map2y, cv2.INTER_LINEAR)
        
        return rectified_left, rectified_right
    
    # ä¿å­˜å‚æ•°
    def save_calibration_to_json(self, k_left, dist_left, k_right, dist_right, R, T, Q, E=None, F=None):
        calibration_data = {
            "k_left": k_left.tolist(),
            "dist_left": dist_left.tolist(),
            "k_right": k_right.tolist(),
            "dist_right": dist_right.tolist(),
            "R": R.tolist(),
            "T": T.tolist(),
            "Q": Q.tolist()
        }

        # å°†å­—å…¸ä¿å­˜ä¸ºJSONæ–‡ä»¶
        with open('cali_circle.json', "w") as json_file:
            json.dump(calibration_data, json_file, indent=4)
    # è¯»å–å‚æ•°
    def load_calibration_from_json(self, file_path):
        with open(file_path, 'r') as json_file:
            calibration_data = json.load(json_file)
        k_left, dist_left, k_right, dist_right, R, T, Q = calibration_data['k_left'], calibration_data['dist_left'], calibration_data['k_right'], calibration_data['dist_right'], calibration_data['R'], calibration_data['T'], calibration_data['Q']
        # self.calculate_fx_fy_cx_cy_baseline(Q)
        return k_left, dist_left, k_right, dist_right, R, T, Q
    
    # å¯è§†åŒ–è§†å·®å›¾
    def visualize_disparity_map(self, disparity_map):
        min_depth, max_depth = 1, 10
        min_disparity = self.fx / float(min_depth * self.baseline) 
        max_disparity = self.fx / float(max_depth * self.baseline) 
        
        disparity_map = np.where(disparity_map < 0, 0, disparity_map)
        disparity_map = disparity_map.astype(np.float32)
        
        disparity_map = np.clip(disparity_map, min_disparity, max_disparity)
        norm_disparity_map = 255 * (disparity_map / (max_disparity - min_disparity))  # å½’ä¸€åŒ–åˆ°[0, 255]

        color_disparity_map = cv2.applyColorMap(cv2.convertScaleAbs(norm_disparity_map, 1), cv2.COLORMAP_JET)
        return color_disparity_map

if __name__ == "__main__":
    stereo_rectify = stereoRectify(findChessboardCorners=False)
    
    # å›¾åƒè·¯å¾„
    img_dir_left = r"left"
    img_dir_right = r"right"
    img_type = "png"  # å›¾ç‰‡æ ¼å¼

    # åŠ è½½å›¾åƒæ–‡ä»¶
    images_left = sorted(glob.glob(img_dir_left + os.sep + '*.' + img_type))
    images_right = sorted(glob.glob(img_dir_right + os.sep + '*.' + img_type))
    k_left, dist_left, k_right, dist_right, R, T, Q = stereo_rectify.stereo_calibrate(images_left, images_right)
    stereo_rectify.save_calibration_to_json(k_left, dist_left, k_right, dist_right, R, T, Q)
    
    # è¯»å–å‚æ•°
    # k_left, dist_left, k_right, dist_right, R, T, Q = stereo_rectify.load_calibration_from_json('cali_circle.json')
    # print("calibration_data: \n", k_left, dist_left, k_right, dist_right, R, T, Q)

                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             %$EÄĞ•Rj­ã8–—ËeDHnİºõø~é™gyäú#s%’lKb›àg’3"¢:mK
EËVk}å;ÿü…/|á‘GÙÛÛ[¯×Àz½n­Íól»v­5wÀœÔZ§iªm@Rf²S<€Ìt§0§¸ã~Í6$Îa›c›_Il°-	°™t!©µÆ6Á6[IbÛ¼-u€ºÅb—m$±İ<ã<Ï¶%µÖ^}õÕO~ò“¿ıÛ¿ıíoû;ßùNDHZ¯×™	LÓÄ9l¶Û€íÖÌ6¥”ÖIŠˆRJkÍö0’,ÑI¢s'	Ä	ÛœPH"‚N§,w
PºE7C)egggww÷Ê•+×®]{øá‡¯\¹µÖqØå™i(¥DDk-3ßxãÆ­[·nŞ¼ytt4Ïóz½ç¹µ6MSk­Öj°İºZóXÄ(ÉvfÒEDf¶Û€;¶i­q¶Ù¦”Â6™É}Ç Ilc›m"BgIbIt!	¨$E 	p±¤0ê"¢H€¤RÊb•R$dûá‡¯>şøãÿò¯/?óÌ3¥@%@™H~&Å±0“ú‰o|ã_ùÊWŞûŞ÷®×kàîİ»µÖišj­™i»Öš™µEfºËLÛ™é€»Ìt—™¶3pGç°™€m:Û€mÀ6§Ø2Ó6çğ)@fÚ¦“d°¸$qAî8+3m£ä,w<°ìØàj@ 	d;3Ù )•îÔef­µµvõêÕ'Ÿ|r±XDÄ½{÷^zé¥ƒƒƒår™gÙl¶Ût’Ø`›Î6™@v€¤àg$ÑIâç&%2÷‰®µVkm­Ù$Ù2°Øf»¸lg&íÌd}âù¸¥$@€$Ûl#
ÛHbIœ¥SlsL)É)@RDH$QJ‰I@DÃm5—.]ªµ¢”´\Ó4E éæÍ›¯¿şú•«ûO>ùä³Ï>û¹Ï}Nò~ô£×^{mš¦ˆ˜¦ÉöÎÎ¤RÊ0t±èRqéÒ%§®\¹rõêÕú§úOÿéOŸ~úiI¼¥ğSi–D 	HÔq""€0’ I€N°!b$’ Il“BRâŸ Sdfëj­ÙÉHÔ’€ˆ “Ä&:@`Pê I€TEWJ‰ˆq#"¥”åri;"–ËåƒWl?ñÄ¿õ[¿µ¿¿?Ïs)%3#‚m‚ŸI~¦D©­ÎÙ"b,£P’é\Tß¸qãË_şò÷¿ÿı+W®,—Ëišl×Z3³vó<·H•ÖÚ4MëõºÖš™¶ˆ`›VÍY¶Ù&3m£äÛlÑ Û\m¶±ÍÈLŞI)…¶%ÙÎNR)…·%‰­BÇx